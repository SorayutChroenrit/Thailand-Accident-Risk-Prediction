import { createFileRoute } from "@tanstack/react-router";
import { useState, useRef, useEffect, useMemo } from "react";
import { Header } from "~/components/layout/Header";
import { Footer } from "~/components/layout/Footer";
import { Card, CardContent, CardHeader, CardTitle } from "~/components/ui/card";
import { Badge } from "~/components/ui/badge";
import { Button } from "~/components/ui/button";
import {
  MapPin,
  AlertTriangle,
  Filter,
  X,
  TrendingUp,
  Clock,
  Navigation,
  RefreshCw,
  Layers,
  List,
  Info,
  Car,
  Construction,
  Cloud,
  Skull,
  ShieldAlert,
  Loader2,
} from "lucide-react";
import { useLanguage } from "~/contexts/LanguageContext";
import { ProtectedRoute } from "~/components/ProtectedRoute";
import { waitForLongdo } from "~/lib/longdo";
import {
  getRiskEvents,
  getHighRiskZones,
  formatEventTime,
  getEventTypeLabel,
  getSeverityLabel,
  getEventColor,
  getEventStatistics,
  type RiskEvent,
  type EventFilter,
} from "~/lib/event-manager";
import {
  fetchTrafficIndex,
  getBangkokTrafficIndex,
} from "~/lib/traffic-service";
import { calculateRiskScore, getRiskIndex } from "~/lib/risk-calculator";

export const Route = createFileRoute("/risk-map")({
  component: () => (
    <ProtectedRoute>
      <RiskMapPage />
    </ProtectedRoute>
  ),
});

function RiskMapPage() {
  const { language } = useLanguage();

  // State
  const [loading, setLoading] = useState(true);
  const [events, setEvents] = useState<RiskEvent[]>([]);
  const [filteredEvents, setFilteredEvents] = useState<RiskEvent[]>([]);
  const [trafficIndex, setTrafficIndex] = useState<number>(5);
  const [riskIndex, setRiskIndex] = useState<number>(5);
  const [showSidebar, setShowSidebar] = useState(true);
  const [showLegend, setShowLegend] = useState(true);
  const [selectedEvent, setSelectedEvent] = useState<RiskEvent | null>(null);
  const [userLocation, setUserLocation] = useState<{
    lat: number;
    lng: number;
  } | null>(null);

  // Filter state
  const [activeFilters, setActiveFilters] = useState<EventFilter>({
    types: ["accident", "breakdown", "construction", "congestion", "weather"],
    severities: ["low", "medium", "high"],
  });

  // Map refs
  const mapRef = useRef<any>(null);
  const mapContainerRef = useRef<HTMLDivElement>(null);
  const markersRef = useRef<Map<string, any>>(new Map());

  // Load initial data
  useEffect(() => {
    const loadData = async () => {
      try {
        setLoading(true);

        // Get user location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              setUserLocation({
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              });
            },
            () => {
              // Default to Bangkok
              setUserLocation({ lat: 13.7563, lng: 100.5018 });
            },
          );
        } else {
          setUserLocation({ lat: 13.7563, lng: 100.5018 });
        }

        // Fetch traffic index
        const trafficIdx = await getBangkokTrafficIndex();
        setTrafficIndex(trafficIdx);

        // Calculate risk index
        const riskScore = await calculateRiskScore({
          lat: 13.7563,
          lng: 100.5018,
        });
        setRiskIndex(getRiskIndex(riskScore.overall));

        // Fetch events
        const trafficEvents = await getRiskEvents(
          {
            north: 13.95,
            south: 13.55,
            east: 100.75,
            west: 100.35,
          },
          {
            userLocation: userLocation || undefined,
          },
        );

        // Add high-risk zones
        const highRiskZones = getHighRiskZones();
        const allEvents = [...trafficEvents, ...highRiskZones];

        setEvents(allEvents);
        setFilteredEvents(allEvents);
      } catch (error) {
        console.error("Error loading risk map data:", error);
      } finally {
        setLoading(false);
      }
    };

    loadData();

    // Set up auto-refresh every 5 minutes
    const interval = setInterval(loadData, 5 * 60 * 1000);
    return () => clearInterval(interval);
  }, []);

  // Apply filters
  useEffect(() => {
    let filtered = [...events];

    if (activeFilters.types && activeFilters.types.length > 0) {
      filtered = filtered.filter((event) =>
        activeFilters.types?.includes(event.type),
      );
    }

    if (activeFilters.severities && activeFilters.severities.length > 0) {
      filtered = filtered.filter((event) =>
        activeFilters.severities?.includes(event.severity),
      );
    }

    setFilteredEvents(filtered);
  }, [events, activeFilters]);

  // Initialize map
  useEffect(() => {
    if (!mapContainerRef.current || mapRef.current) return;

    const initMap = async () => {
      await waitForLongdo();

      if (!mapContainerRef.current || !(window as any).longdo) return;

      const centerLat = userLocation?.lat || 13.7563;
      const centerLng = userLocation?.lng || 100.5018;

      const map = new (window as any).longdo.Map({
        placeholder: mapContainerRef.current,
        location: { lon: centerLng, lat: centerLat },
        zoom: 12,
        language: language === "th" ? "th" : "en",
      });

      // Add Traffic Layer overlay for real-time traffic visualization
      map.Layers.add((window as any).longdo.Layers.TRAFFIC);

      mapRef.current = map;

      // Add user location marker if available
      if (userLocation) {
        const userMarker = new (window as any).longdo.Marker(
          { lon: userLocation.lng, lat: userLocation.lat },
          {
            title: language === "en" ? "Your Location" : "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
            icon: {
              html: `<div style="background: #2563EB; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
              offset: { x: 10, y: 10 },
            },
          },
        );
        map.Overlays.add(userMarker);
      }
    };

    initMap();

    return () => {
      if (mapRef.current) {
        mapRef.current.Overlays.clear();
      }
    };
  }, [userLocation, language]);

  // Update markers when events change
  useEffect(() => {
    if (!mapRef.current) return;

    // Clear existing markers (except user marker)
    markersRef.current.forEach((marker) => {
      mapRef.current.Overlays.remove(marker);
    });
    markersRef.current.clear();

    // Add new markers
    filteredEvents.forEach((event) => {
      const color = getEventColor(event.severity);
      const icon = getEventIcon(event.type);

      const marker = new (window as any).longdo.Marker(
        { lon: event.location.lng, lat: event.location.lat },
        {
          title: language === "en" ? event.title_en : event.title_th,
          detail: `
            <div style="font-family: system-ui; padding: 4px; min-width: 200px;">
              <strong>${language === "en" ? event.title_en : event.title_th}</strong><br/>
              <span style="color: ${color}; font-weight: bold;">
                ${getSeverityLabel(event.severity, language)}
              </span><br/>
              <small>${event.roadName || ""}</small><br/>
              <small style="color: #666;">${formatEventTime(event.timestamp, language)}</small>
            </div>
          `,
          icon: {
            html: `<div style="
              background: ${color};
              width: ${event.severity === "high" ? "32px" : event.severity === "medium" ? "24px" : "20px"};
              height: ${event.severity === "high" ? "32px" : event.severity === "medium" ? "24px" : "20px"};
              border-radius: 50%;
              border: 3px solid white;
              box-shadow: 0 2px 8px rgba(0,0,0,0.3);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: ${event.severity === "high" ? "16px" : "12px"};
            ">${icon}</div>`,
            offset: { x: 16, y: 16 },
          },
        },
      );

      // Click handler
      const clickHandler = () => {
        setSelectedEvent(event);
        mapRef.current.location(
          { lon: event.location.lng, lat: event.location.lat },
          true,
        );
      };

      mapRef.current.Event.bind("overlayClick", (overlay: any) => {
        if (overlay === marker) {
          clickHandler();
        }
      });

      mapRef.current.Overlays.add(marker);
      markersRef.current.set(event.id, marker);
    });
  }, [filteredEvents, language]);

  // Toggle filter
  const toggleFilter = (filterType: "type" | "severity", value: string) => {
    if (filterType === "type") {
      const types = activeFilters.types || [];
      const newTypes = types.includes(value as any)
        ? types.filter((t) => t !== value)
        : [...types, value as any];
      setActiveFilters({ ...activeFilters, types: newTypes });
    } else {
      const severities = activeFilters.severities || [];
      const newSeverities = severities.includes(value as any)
        ? severities.filter((s) => s !== value)
        : [...severities, value as any];
      setActiveFilters({ ...activeFilters, severities: newSeverities });
    }
  };

  // Event statistics
  const stats = useMemo(
    () => getEventStatistics(filteredEvents),
    [filteredEvents],
  );

  // Get icon for event type
  const getEventIcon = (type: RiskEvent["type"]): string => {
    const icons = {
      accident: "üí•",
      breakdown: "‚ö†Ô∏è",
      construction: "üöß",
      congestion: "üö¶",
      weather: "üåßÔ∏è",
    };
    return icons[type] || "‚ö†Ô∏è";
  };

  // Get traffic level info
  const getTrafficInfo = (index: number) => {
    if (index <= 3)
      return {
        level: "low",
        label_en: "Low",
        label_th: "‡∏ï‡πà‡∏≥",
        color: "#22C55E",
      };
    if (index <= 5)
      return {
        level: "moderate",
        label_en: "Moderate",
        label_th: "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á",
        color: "#F59E0B",
      };
    if (index <= 7)
      return {
        level: "high",
        label_en: "High",
        label_th: "‡∏™‡∏π‡∏á",
        color: "#EA580C",
      };
    return {
      level: "severe",
      label_en: "Severe",
      label_th: "‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á",
      color: "#DC2626",
    };
  };

  const trafficInfo = getTrafficInfo(trafficIndex);
  const riskInfo = getTrafficInfo(riskIndex);

  if (loading) {
    return (
      <div className="flex min-h-screen flex-col">
        <Header />
        <main className="flex-1 flex items-center justify-center">
          <div className="text-center">
            <Loader2 className="h-12 w-12 animate-spin text-primary mx-auto mb-4" />
            <p className="text-muted-foreground">
              {language === "en"
                ? "Loading risk map..."
                : "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á..."}
            </p>
          </div>
        </main>
        <Footer />
      </div>
    );
  }

  return (
    <div className="flex min-h-screen flex-col">
      <Header />

      <main className="flex-1 relative">
        {/* Map Container */}
        <div className="absolute inset-0">
          <div ref={mapContainerRef} className="w-full h-full" />
        </div>

        {/* Top Bar - Traffic & Risk Index */}
        <div className="absolute top-4 left-4 right-4 z-[1000] pointer-events-none">
          <div className="flex items-center gap-2 pointer-events-auto">
            <Card className="shadow-lg">
              <CardContent className="py-3 px-4">
                <div className="flex items-center gap-3">
                  <Car className="h-5 w-5 text-primary" />
                  <div>
                    <p className="text-xs text-muted-foreground">
                      {language === "en" ? "Traffic Index" : "‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏à‡∏£‡∏≤‡∏à‡∏£"}
                    </p>
                    <div className="flex items-center gap-2">
                      <span
                        className="text-2xl font-bold"
                        style={{ color: trafficInfo.color }}
                      >
                        {trafficIndex}
                      </span>
                      <span
                        className="text-sm font-medium"
                        style={{ color: trafficInfo.color }}
                      >
                        {language === "en"
                          ? trafficInfo.label_en
                          : trafficInfo.label_th}
                      </span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card className="shadow-lg">
              <CardContent className="py-3 px-4">
                <div className="flex items-center gap-3">
                  <AlertTriangle className="h-5 w-5 text-primary" />
                  <div>
                    <p className="text-xs text-muted-foreground">
                      {language === "en" ? "Risk Index" : "‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á"}
                    </p>
                    <div className="flex items-center gap-2">
                      <span
                        className="text-2xl font-bold"
                        style={{ color: riskInfo.color }}
                      >
                        {riskIndex}
                      </span>
                      <span
                        className="text-sm font-medium"
                        style={{ color: riskInfo.color }}
                      >
                        {language === "en"
                          ? riskInfo.label_en
                          : riskInfo.label_th}
                      </span>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            <div className="flex-1" />

            <Button
              variant="secondary"
              size="icon"
              className="shadow-lg"
              onClick={() => window.location.reload()}
            >
              <RefreshCw className="h-4 w-4" />
            </Button>

            <Button
              variant="secondary"
              size="icon"
              className="shadow-lg"
              onClick={() => setShowSidebar(!showSidebar)}
            >
              <List className="h-4 w-4" />
            </Button>
          </div>
        </div>

        {/* Legend - Bottom Left */}
        {showLegend && (
          <div className="absolute bottom-4 left-4 z-[1000]">
            <Card className="shadow-lg">
              <CardHeader className="pb-2">
                <div className="flex items-center justify-between">
                  <CardTitle className="text-sm flex items-center gap-2">
                    <Info className="h-4 w-4" />
                    {language === "en" ? "Legend" : "‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå"}
                  </CardTitle>
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-6 w-6"
                    onClick={() => setShowLegend(false)}
                  >
                    <X className="h-3 w-3" />
                  </Button>
                </div>
              </CardHeader>
              <CardContent className="pt-0 space-y-2">
                <div className="flex items-center gap-2 text-xs">
                  <div className="w-4 h-4 rounded-full bg-risk-high border-2 border-white" />
                  <span>
                    {language === "en" ? "High Risk" : "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á"}
                  </span>
                </div>
                <div className="flex items-center gap-2 text-xs">
                  <div className="w-3 h-3 rounded-full bg-risk-medium border-2 border-white" />
                  <span>
                    {language === "en" ? "Medium Risk" : "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"}
                  </span>
                </div>
                <div className="flex items-center gap-2 text-xs">
                  <div className="w-3 h-3 rounded-full bg-risk-low border-2 border-white" />
                  <span>
                    {language === "en" ? "Low Risk" : "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥"}
                  </span>
                </div>
                <div className="pt-2 border-t space-y-1">
                  <div className="text-xs flex items-center gap-2">
                    <span>üí•</span>{" "}
                    {language === "en" ? "Accident" : "‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏"}
                  </div>
                  <div className="text-xs flex items-center gap-2">
                    <span>‚ö†Ô∏è</span> {language === "en" ? "Breakdown" : "‡∏£‡∏ñ‡πÄ‡∏™‡∏µ‡∏¢"}
                  </div>
                  <div className="text-xs flex items-center gap-2">
                    <span>üöß</span>{" "}
                    {language === "en" ? "Construction" : "‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á"}
                  </div>
                  <div className="text-xs flex items-center gap-2">
                    <span>üö¶</span> {language === "en" ? "Congestion" : "‡∏£‡∏ñ‡∏ï‡∏¥‡∏î"}
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {!showLegend && (
          <Button
            variant="secondary"
            size="icon"
            className="absolute bottom-4 left-4 z-[1000] shadow-lg"
            onClick={() => setShowLegend(true)}
          >
            <Layers className="h-4 w-4" />
          </Button>
        )}

        {/* Sidebar - Event List */}
        {showSidebar && (
          <div className="absolute top-20 right-4 bottom-4 w-96 z-[1000] flex flex-col gap-2">
            {/* Filters */}
            <Card className="shadow-lg">
              <CardHeader className="pb-3">
                <CardTitle className="text-sm flex items-center gap-2">
                  <Filter className="h-4 w-4" />
                  {language === "en" ? "Filters" : "‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á"}
                </CardTitle>
              </CardHeader>
              <CardContent className="pt-0 space-y-3">
                {/* Event Type Filters */}
                <div>
                  <p className="text-xs text-muted-foreground mb-2">
                    {language === "en" ? "Event Type" : "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå"}
                  </p>
                  <div className="flex flex-wrap gap-1">
                    {[
                      "accident",
                      "breakdown",
                      "construction",
                      "congestion",
                      "weather",
                    ].map((type) => (
                      <Badge
                        key={type}
                        variant={
                          activeFilters.types?.includes(type as any)
                            ? "default"
                            : "outline"
                        }
                        className="cursor-pointer text-xs"
                        onClick={() => toggleFilter("type", type)}
                      >
                        {getEventTypeLabel(type as any, language)}
                      </Badge>
                    ))}
                  </div>
                </div>

                {/* Severity Filters */}
                <div>
                  <p className="text-xs text-muted-foreground mb-2">
                    {language === "en" ? "Severity" : "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á"}
                  </p>
                  <div className="flex gap-1">
                    {["low", "medium", "high"].map((severity) => (
                      <Badge
                        key={severity}
                        variant={
                          activeFilters.severities?.includes(severity as any)
                            ? "default"
                            : "outline"
                        }
                        className="cursor-pointer text-xs"
                        onClick={() => toggleFilter("severity", severity)}
                        style={{
                          borderColor: activeFilters.severities?.includes(
                            severity as any,
                          )
                            ? getEventColor(severity as any)
                            : undefined,
                          backgroundColor: activeFilters.severities?.includes(
                            severity as any,
                          )
                            ? getEventColor(severity as any)
                            : undefined,
                        }}
                      >
                        {getSeverityLabel(severity as any, language)}
                      </Badge>
                    ))}
                  </div>
                </div>

                {/* Stats */}
                <div className="pt-2 border-t">
                  <div className="flex justify-between text-xs">
                    <span className="text-muted-foreground">
                      {language === "en" ? "Total Events" : "‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"}
                    </span>
                    <span className="font-medium">{stats.total}</span>
                  </div>
                  <div className="flex justify-between text-xs mt-1">
                    <span className="text-muted-foreground">
                      {language === "en" ? "Recent (1h)" : "‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (1 ‡∏ä‡∏°.)"}
                    </span>
                    <span className="font-medium text-primary">
                      {stats.recentCount}
                    </span>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Event List */}
            <Card className="shadow-lg flex-1 overflow-hidden flex flex-col">
              <CardHeader className="pb-3">
                <CardTitle className="text-sm flex items-center gap-2">
                  <AlertTriangle className="h-4 w-4" />
                  {language === "en" ? "Active Events" : "‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô"}
                  <Badge variant="secondary" className="ml-auto">
                    {filteredEvents.length}
                  </Badge>
                </CardTitle>
              </CardHeader>
              <CardContent className="pt-0 flex-1 overflow-y-auto">
                <div className="space-y-2">
                  {filteredEvents.length === 0 ? (
                    <p className="text-sm text-muted-foreground text-center py-4">
                      {language === "en" ? "No events found" : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå"}
                    </p>
                  ) : (
                    filteredEvents.map((event) => (
                      <div
                        key={event.id}
                        className={`p-3 rounded-lg border cursor-pointer transition-colors ${
                          selectedEvent?.id === event.id
                            ? "bg-primary/10 border-primary"
                            : "hover:bg-muted"
                        }`}
                        onClick={() => {
                          setSelectedEvent(event);
                          if (mapRef.current) {
                            mapRef.current.location(
                              {
                                lon: event.location.lng,
                                lat: event.location.lat,
                              },
                              true,
                            );
                          }
                        }}
                      >
                        <div className="flex items-start gap-2">
                          <div
                            className="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0"
                            style={{
                              backgroundColor:
                                getEventColor(event.severity) + "20",
                            }}
                          >
                            <span>{getEventIcon(event.type)}</span>
                          </div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-start justify-between gap-2">
                              <p className="font-medium text-sm truncate">
                                {language === "en"
                                  ? event.title_en
                                  : event.title_th}
                              </p>
                              <Badge
                                variant="secondary"
                                className="text-xs"
                                style={{
                                  backgroundColor:
                                    getEventColor(event.severity) + "20",
                                  color: getEventColor(event.severity),
                                  borderColor: getEventColor(event.severity),
                                }}
                              >
                                {getSeverityLabel(event.severity, language)}
                              </Badge>
                            </div>
                            <p className="text-xs text-muted-foreground mt-1">
                              {event.roadName || ""}
                            </p>
                            <div className="flex items-center gap-2 mt-2 text-xs text-muted-foreground">
                              <Clock className="h-3 w-3" />
                              <span>
                                {formatEventTime(event.timestamp, language)}
                              </span>
                              {event.distance && (
                                <>
                                  <span>‚Ä¢</span>
                                  <MapPin className="h-3 w-3" />
                                  <span>{event.distance.toFixed(1)} km</span>
                                </>
                              )}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </CardContent>
            </Card>
          </div>
        )}
      </main>
    </div>
  );
}
