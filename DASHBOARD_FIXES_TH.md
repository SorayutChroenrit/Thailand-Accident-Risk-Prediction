# คู่มือการแก้ไขแดชบอร์ด

## ปัญหาที่แก้ไขแล้ว

1. ✅ **ปัญหาตัวกรอง**: เดิมมีเฉพาะตัวกรองจังหวัดที่ทำงาน แต่ตัวกรองระดับความรุนแรง ประเภทรถ และสภาพอากาศไม่ทำงาน
2. ✅ **ปัญหาสีแผนที่ความร้อน**: เมื่อเลือกจังหวัด จังหวัดอื่นจะเปลี่ยนเป็นสีเทาแทนที่จะคงความเข้มของสีไว้
3. ✅ **กราฟสภาพอากาศว่างเปล่า**: กราฟสภาพอากาศไม่มีข้อมูลเพราะ API ไม่ส่งข้อมูลสภาพอากาศมา

## การเปลี่ยนแปลงที่ทำ

### 1. การเปลี่ยนแปลง Backend

#### A. อัปเดต SQL Function (`backend/create_dashboard_aggregate_function.sql`)
- เพิ่มพารามิเตอร์ `p_casualty_type` เพื่อกรองตามระดับความรุนแรง (เสียชีวิต/สาหัส/เล็กน้อย/รอดชีวิต)
- เพิ่ม `weather_stats` CTE เพื่อรวบรวมข้อมูลสภาพอากาศ
- เพิ่มตรรกะการกรองตามประเภทการบาดเจ็บใน WHERE clause
- อัปเดตคำสั่ง GRANT เพื่อรองรับพารามิเตอร์ใหม่

#### B. อัปเดต API (`backend/main.py`)
- เพิ่มพารามิเตอร์ `p_casualty_type` ไปยังการเรียก RPC function
- เพิ่มฟิลด์ `weather_data` ในการแมปผลลัพธ์

### 2. การเปลี่ยนแปลง Frontend

#### A. อัปเดต TypeScript Interface (`frontend/src/lib/dashboard-service.ts`)
- เพิ่มฟิลด์ `weather_data` ใน `DashboardStats` interface

#### B. อัปเดต Dashboard Component (`frontend/src/routes/dashboard.tsx`)
- แก้ไข `weatherData` ให้ใช้ข้อมูลจาก API แทนที่จะเป็น array ว่าง
- แก้ไขแผนที่ความร้อนให้คงสีของจังหวัดไว้เมื่อกรอง (เอาเอฟเฟกต์สีเทาออก)
- แก้ไขการเลือกจังหวัดให้ใช้การเปรียบเทียบชื่อแทน ID
- แก้ไขปัญหา type ของ label ในกราฟวงกลม

## วิธีการใช้งานการเปลี่ยนแปลงเหล่านี้

### ขั้นตอนที่ 1: อัปเดตฟังก์ชันในฐานข้อมูล

คุณต้องอัปเดตฟังก์ชัน PostgreSQL ในฐานข้อมูล Supabase ของคุณ:

**ตัวเลือก A: ใช้ Supabase SQL Editor (แนะนำ)**
1. ไปที่ Supabase Dashboard: https://supabase.com/dashboard
2. ไปที่: SQL Editor (แถบด้านซ้าย)
3. เปิดไฟล์: `backend/create_dashboard_aggregate_function.sql`
4. คัดลอกเนื้อหาทั้งหมดและวางลงใน SQL Editor
5. คลิก **"Run"** เพื่อรัน

**ตัวเลือก B: ใช้ Python Script**
```bash
cd backend
python update_dashboard_function.py
```
หมายเหตุ: สคริปต์นี้จะแนะนำขั้นตอนแบบ manual เพราะ Supabase Python client ไม่รองรับการรัน SQL โดยตรง

**ตัวเลือก C: ใช้ psql Command Line**
```bash
cd backend
psql 'YOUR_DATABASE_URL' < create_dashboard_aggregate_function.sql
```

### ขั้นตอนที่ 2: รีสตาร์ท Backend Server

หลังจากอัปเดตฟังก์ชันในฐานข้อมูลแล้ว รีสตาร์ท FastAPI server:

```bash
cd backend
python main.py
```

### ขั้นตอนที่ 3: รีสตาร์ท Frontend

การเปลี่ยนแปลง frontend มีอยู่แล้ว เพียงรีสตาร์ท dev server:

```bash
cd frontend
npm run dev
```

## การทดสอบการแก้ไข

### 1. ทดสอบตัวกรองจังหวัด
- เปิดแดชบอร์ด: http://localhost:5173/dashboard
- เลือกจังหวัดใดก็ได้จาก dropdown
- ✅ แผนที่ความร้อนควรคงสีของทุกจังหวัดไว้ (ไม่เปลี่ยนเป็นสีเทา)
- ✅ จังหวัดที่เลือกควรมีขอบหนาขึ้น (weight: 3)
- ✅ สถิติทั้งหมดควรอัปเดตเพื่อแสดงเฉพาะข้อมูลของจังหวัดนั้น

### 2. ทดสอบตัวกรองระดับความรุนแรง
- เลือก "ผู้เสียชีวิต" (Fatal) จาก dropdown
- ✅ สถิติควรอัปเดตเพื่อแสดงเฉพาะอุบัติเหตุที่มีผู้เสียชีวิต
- ✅ กราฟทั้งหมดควรสะท้อนข้อมูลที่กรองแล้ว

### 3. ทดสอบตัวกรองประเภทรถ
- เลือก "รถจักรยานยนต์" (Motorcycle) จาก dropdown
- ✅ สถิติควรอัปเดตเพื่อแสดงเฉพาะอุบัติเหตุของรถจักรยานยนต์
- ✅ กราฟประเภทรถควรอัปเดตตามนั้น

### 4. ทดสอบตัวกรองสภาพอากาศ
- เลือก "ฝนตก" (Rain) จาก dropdown
- ✅ สถิติควรอัปเดตเพื่อแสดงเฉพาะอุบัติเหตุที่เกิดในฝนตก
- ✅ กราฟสภาพอากาศควรมีข้อมูลแสดงแล้ว

### 5. ทดสอบการใช้หลายตัวกรองพร้อมกัน
- ลองเลือกหลายตัวกรองพร้อมกัน
- ✅ ตัวกรองทั้งหมดควรทำงานร่วมกันได้อย่างถูกต้อง
- ✅ ข้อมูลควรถูกกรองด้วยเงื่อนไขทั้งหมดที่เลือก

### 6. ทดสอบกราฟสภาพอากาศ
- กราฟสภาพอากาศควรแสดงข้อมูลแทนที่จะว่างเปล่า
- ✅ ควรแสดงแท่งกราฟสำหรับ: แจ่มใส (Clear), ฝนตก (Rain), มืดครึ้ม (Overcast)
- ✅ tooltip เมื่อ hover ควรทำงาน

## พารามิเตอร์ API

Dashboard API ตอนนี้รับพารามิเตอร์เหล่านี้:

```
GET /dashboard/stats?date_range=all&province=all&casualty_type=all&vehicle_type=all&weather=all
```

### ค่าที่ใช้ได้:

**date_range:**
- `all`, `2025`, `2024`, `2023`, `2022`, `2021`, `2020`, `2019`

**province:**
- `all` หรือชื่อจังหวัดภาษาไทย (เช่น `กรุงเทพมหานคร`)

**casualty_type:** ⭐ ใหม่
- `all`, `fatal`, `serious`, `minor`, `survivors`

**vehicle_type:**
- `all` หรือประเภทรถใดก็ได้ (เช่น `รถจักรยานยนต์`)

**weather:** ⭐ ทำงานได้แล้ว
- `all`, `แจ่มใส`, `ฝนตก`, `มืดครึ้ม`

## ลายเซ็นฟังก์ชันในฐานข้อมูล

```sql
CREATE OR REPLACE FUNCTION get_dashboard_stats(
    p_start_date TEXT DEFAULT '2019-01-01',
    p_end_date TEXT DEFAULT '2025-12-31',
    p_province TEXT DEFAULT 'all',
    p_vehicle_type TEXT DEFAULT 'all',
    p_weather TEXT DEFAULT 'all',
    p_casualty_type TEXT DEFAULT 'all'  -- พารามิเตอร์ใหม่
)
RETURNS JSON
```

## การแก้ปัญหา

### ปัญหา: ตัวกรองยังไม่ทำงาน
- ตรวจสอบว่าคุณอัปเดต SQL function ใน Supabase แล้ว
- รีสตาร์ท backend server
- ล้าง browser cache และโหลดใหม่

### ปัญหา: กราฟสภาพอากาศยังว่างอยู่
- ตรวจสอบว่าฐานข้อมูลของคุณมีคอลัมน์ `weather_condition` ที่มีข้อมูล
- ตรวจสอบว่า SQL function ส่ง `weather_data` มาในผลลัพธ์
- ตรวจสอบ browser console หา API errors

### ปัญหา: แผนที่ความร้อนยังเปลี่ยนเป็นสีเทา
- ตรวจสอบว่าคุณดึง frontend code ล่าสุดมาแล้ว
- ล้าง browser cache
- ตรวจสอบว่าบรรทัด 384-392 และ 466-471 ใน `dashboard.tsx` ไม่มีโค้ดสีเทา

### ปัญหา: เกิดข้อผิดพลาด "Function not found"
- SQL function ยังไม่ได้อัปเดตใน Supabase
- ทำขั้นตอนที่ 1 อีกครั้งเพื่ออัปเดตฟังก์ชันในฐานข้อมูล
- ตรวจสอบว่าคุณใช้ Supabase project ที่ถูกต้อง

## สนับสนุน

หากคุณพบปัญหา:
1. ตรวจสอบ browser console หา errors
2. ตรวจสอบ backend logs หา API errors
3. ตรวจสอบว่า SQL function มีอยู่ใน Supabase
4. ตรวจสอบว่า environment variables ทั้งหมดตั้งค่าถูกต้อง

## สรุป

ตัวกรองแดشบอร์ดทั้งหมดทำงานถูกต้องแล้ว:
- ✅ ตัวกรองจังหวัด
- ✅ ตัวกรองช่วงวันที่
- ✅ ตัวกรองระดับความรุนแรง - **ทำงานได้แล้ว**
- ✅ ตัวกรองประเภทรถ - **ทำงานได้แล้ว**
- ✅ ตัวกรองสภาพอากาศ - **ทำงานได้แล้ว**

พฤติกรรมแผนที่ความร้อนดีขึ้น:
- ✅ จังหวัดคงความเข้มของสีไว้เมื่อกรอง
- ✅ จังหวัดที่เลือกถูกเน้นด้วยขอบหนาขึ้น

กราฟสภาพอากาศมีข้อมูลแล้ว:
- ✅ แสดงการกระจายของสภาพอากาศ
- ✅ อัปเดตตามตัวกรองที่เลือก